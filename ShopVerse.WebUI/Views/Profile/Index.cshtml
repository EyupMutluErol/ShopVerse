@using ShopVerse.WebUI.Models
@using ShopVerse.Entities.Enums
@model UserProfileViewModel

@{
    ViewData["Title"] = "Hesabım";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">

<style>
    :root {
        --blue-gradient: linear-gradient(135deg, #00c6ff 0%, #0072ff 100%);
        --blue-primary: #0072ff;
    }

    .profile-card {
        border: none;
        border-radius: 20px;
        overflow: hidden;
        box-shadow: 0 10px 30px rgba(0,0,0,0.05);
        background: white;
    }

    .custom-nav-pills {
        background: #e9ecef;
        padding: 6px;
        border-radius: 50px;
        display: inline-flex;
        gap: 5px;
        flex-wrap: wrap;
    }

        .custom-nav-pills .nav-link {
            color: #495057 !important;
            background: transparent !important;
            border-radius: 40px;
            padding: 10px 30px;
            font-weight: 600;
            transition: all 0.3s ease;
            border: none;
        }

            .custom-nav-pills .nav-link:hover {
                background: #dee2e6 !important;
                color: #000000 !important;
            }

            .custom-nav-pills .nav-link.active {
                background: var(--blue-primary) !important;
                color: #ffffff !important;
                box-shadow: 0 4px 12px rgba(0, 114, 255, 0.3);
            }

    .transition-hover:hover {
        transform: translateY(-3px);
        box-shadow: 0 10px 20px rgba(0,0,0,0.08) !important;
        transition: all 0.3s ease;
    }
</style>

<div style="min-height: 100vh;">
    <div class="container py-5">

        <div class="d-flex align-items-center justify-content-between mb-4">
            <div>
                <h2 class="fw-bold text-dark mb-1">Hesabım</h2>
                <p class="text-muted mb-0">Hoş geldiniz, <span class="text-primary fw-bold">@Model.User.Name</span></p>
            </div>
            <div class="d-none d-md-block">
                <span class="badge bg-primary rounded-pill px-3 py-2 shadow-sm">
                    <i class="fas fa-star me-1"></i> Standart Üye
                </span>
            </div>
        </div>

        <div class="row g-4">

            <div class="col-md-4 col-lg-3">
                <div class="card border-0 shadow-sm rounded-4 overflow-hidden h-100">
                    <div style="height: 100px; background: linear-gradient(135deg, #0d6efd 0%, #0dcaf0 100%);"></div>

                    <div class="card-body text-center mt-n5">
                        <div class="position-relative d-inline-block mb-3">
                            @if (string.IsNullOrEmpty(Model.User.ImageUrl))
                            {
                                <img src="https://ui-avatars.com/api/?name=@Model.User.Name+@Model.User.Surname&background=fff&color=0d6efd&size=150"
                                     class="rounded-circle shadow border border-4 border-white"
                                     alt="User" width="110" height="110">
                            }
                            else
                            {
                                <img src="/userimages/@Model.User.ImageUrl"
                                     class="rounded-circle shadow border border-4 border-white object-fit-cover"
                                     alt="User" width="110" height="110">
                            }
                        </div>

                        <h5 class="fw-bold text-dark mb-1">@Model.User.Name @Model.User.Surname</h5>
                        <p class="text-secondary small mb-3">@Model.User.Email</p>

                        <div class="d-grid gap-2">
                            <button class="btn btn-outline-primary rounded-pill" onclick="document.getElementById('settings-tab').click()">
                                <i class="fas fa-user-edit me-2"></i>Profili Düzenle
                            </button>
                        </div>

                        <div class="mt-4 text-start">
                            <small class="text-uppercase text-muted fw-bold" style="font-size: 0.7rem;">İstatistikler</small>
                            <div class="d-flex justify-content-between align-items-center mt-2 p-2 bg-light rounded-3">
                                <span class="small text-dark"><i class="fas fa-shopping-bag me-2 text-primary"></i>Toplam Sipariş</span>
                                <span class="fw-bold text-dark">@Model.Orders.Count</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-8 col-lg-9">
                <div class="card border-0 shadow-sm rounded-4 bg-white">

                    <div class="card-header bg-white border-bottom-0 pt-4 px-4">
                        <ul class="nav nav-pills custom-nav-pills card-header-pills" id="profileTabs" role="tablist">
                            <li class="nav-item">
                                <button class="nav-link active" id="orders-tab" data-bs-toggle="tab" data-bs-target="#orders" type="button" role="tab">
                                    <i class="fas fa-box-open me-2"></i>Siparişlerim
                                </button>
                            </li>
                            <li class="nav-item">
                                <button class="nav-link" id="settings-tab" data-bs-toggle="tab" data-bs-target="#settings" type="button" role="tab">
                                    <i class="fas fa-cog me-2"></i>Ayarlar
                                </button>
                            </li>
                            <li class="nav-item">
                                <a href="/Favorite/Index" class="nav-link text-decoration-none">
                                    <i class="fas fa-heart me-2"></i>Favorilerim
                                </a>
                            </li>
                        </ul>
                    </div>

                    <div class="card-body p-4">
                        <div class="tab-content" id="profileTabsContent">

                            <div class="tab-pane fade show active" id="orders" role="tabpanel">
                                @if (Model.Orders == null || Model.Orders.Count == 0)
                                {
                                    <div class="text-center py-5">
                                        <div class="mb-4">
                                            <div class="bg-primary bg-opacity-10 d-inline-flex p-4 rounded-circle">
                                                <i class="fas fa-shopping-cart fa-3x text-primary"></i>
                                            </div>
                                        </div>
                                        <h5 class="fw-bold">Henüz Siparişiniz Yok</h5>
                                        <p class="text-muted">Favori ürünlerinizi keşfetmeye hemen başlayın.</p>
                                        <a asp-controller="Home" asp-action="Index" class="btn btn-primary rounded-pill px-4 py-2 mt-2 shadow-sm">
                                            Alışverişe Başla <i class="fas fa-arrow-right ms-2"></i>
                                        </a>
                                    </div>
                                }
                                else
                                {
                                    <div class="d-flex flex-column gap-3">
                                        @foreach (var order in Model.Orders)
                                        {
                                            <div class="card border border-light shadow-sm rounded-3 overflow-hidden transition-hover">
                                                <div class="card-body p-0">
                                                    <div class="p-3 p-md-4 bg-white d-flex flex-column flex-md-row align-items-md-center justify-content-between gap-3">

                                                        <div class="d-flex align-items-center">
                                                            <div class="rounded-circle bg-primary bg-opacity-10 p-3 me-3 d-flex align-items-center justify-content-center" style="width: 50px; height: 50px;">
                                                                <i class="fas fa-box text-primary fa-lg"></i>
                                                            </div>
                                                            <div>
                                                                <h6 class="mb-0 fw-bold text-dark">Sipariş #@order.OrderNumber</h6>
                                                                <small class="text-muted">
                                                                    <i class="far fa-calendar-alt me-1"></i> @order.OrderDate.ToString("dd MMMM yyyy, HH:mm")
                                                                </small>
                                                            </div>
                                                        </div>

                                                        <div class="text-md-center d-flex flex-column align-items-center justify-content-center">
                                                            @{
                                                                string badgeClass = order.OrderStatus switch
                                                                {
                                                                    OrderStatus.Pending => "bg-warning text-dark",
                                                                    OrderStatus.Approved => "bg-info text-white",
                                                                    OrderStatus.Shipped => "bg-primary text-white",
                                                                    OrderStatus.Delivered => "bg-success text-white",
                                                                    OrderStatus.Canceled => "bg-danger text-white",
                                                                    OrderStatus.Refunded => "bg-secondary text-white",
                                                                    _ => "bg-secondary text-white"
                                                                };

                                                                string statusTr = order.OrderStatus switch
                                                                {
                                                                    OrderStatus.Pending => "Sipariş Alındı",
                                                                    OrderStatus.Approved => "Hazırlanıyor",
                                                                    OrderStatus.Shipped => "Kargoya Verildi",
                                                                    OrderStatus.Delivered => "Teslim Edildi",
                                                                    OrderStatus.Canceled => "İptal Edildi",
                                                                    OrderStatus.Refunded => "İade Edildi",
                                                                    _ => order.OrderStatus.ToString()
                                                                };
                                                            }

                                                            <span class="badge @badgeClass rounded-pill px-3 py-2 border border-white shadow-sm mb-2" style="font-size: 0.85rem;">
                                                                @statusTr
                                                            </span>

                                                            <div class="d-flex gap-2">
                                                                @if (order.OrderStatus == OrderStatus.Pending)
                                                                {
                                                                    <form id="cancelForm-@order.Id" asp-controller="Profile" asp-action="CancelOrder" method="post">
                                                                        <input type="hidden" name="id" value="@order.Id" />
                                                                        <button type="button" class="btn btn-sm btn-outline-danger fw-bold rounded-pill px-3" onclick="confirmCancelOrder(@order.Id)">
                                                                            <i class="fas fa-times me-1"></i> İptal Et
                                                                        </button>
                                                                    </form>
                                                                }

                                                                @if (order.OrderStatus == OrderStatus.Delivered)
                                                                {
                                                                    var deliveryDate = order.DeliveryDate ?? DateTime.Now;
                                                                    var daysSinceDelivery = (DateTime.Now - deliveryDate).TotalDays;

                                                                    if (daysSinceDelivery <= 3)
                                                                    {
                                                                        <form id="returnForm-@order.Id" asp-controller="Profile" asp-action="ReturnOrder" method="post">
                                                                            <input type="hidden" name="id" value="@order.Id" />
                                                                            <button type="button" class="btn btn-sm btn-outline-secondary fw-bold rounded-pill px-3" onclick="confirmReturnOrder(@order.Id)">
                                                                                <i class="fas fa-undo me-1"></i> İade Et
                                                                            </button>
                                                                        </form>
                                                                    }
                                                                }
                                                            </div>
                                                        </div>

                                                        <div class="text-md-end d-flex flex-md-column align-items-center align-items-md-end justify-content-center gap-1">
                                                            <span class="d-block fw-bold text-dark fs-5">@order.TotalPrice.ToString("C2")</span>

                                                            <button class="btn btn-sm btn-light border rounded-pill px-3 text-primary fw-bold mt-1" type="button" onclick="toggleOrder('@order.Id')">
                                                                Detaylar <i class="fas fa-chevron-down ms-1 transition-icon" id="icon-@order.Id"></i>
                                                            </button>
                                                        </div>
                                                    </div>

                                                    <div class="collapse" id="orderDetails-@order.Id">
                                                        <div class="bg-light border-top p-4">
                                                            <div class="mt-0 bg-white rounded-3 shadow-sm overflow-hidden border mb-3">
                                                                <table class="table table-borderless align-middle mb-0">
                                                                    <thead class="bg-light">
                                                                        <tr>
                                                                            <th class="ps-4 py-3 text-secondary small text-uppercase">Ürün Detayı</th>
                                                                            <th class="text-center text-secondary small text-uppercase">Adet</th>
                                                                            <th class="text-end text-secondary small text-uppercase">Birim Fiyat</th>
                                                                            <th class="text-end pe-4 text-secondary small text-uppercase">Toplam</th>
                                                                        </tr>
                                                                    </thead>
                                                                    <tbody>
                                                                        @foreach (var detail in order.OrderDetails)
                                                                        {
                                                                            <tr class="border-bottom last-no-border">
                                                                                <td class="ps-4 py-3">
                                                                                    <div class="d-flex align-items-center">
                                                                                        <div class="bg-light rounded p-2 me-3 border">
                                                                                            <i class="fas fa-cube text-primary fa-lg"></i>
                                                                                        </div>
                                                                                        <div>
                                                                                            <span class="fw-bold text-dark d-block">@detail.Product.Name</span>
                                                                                            <small class="text-muted">Kod: #@detail.ProductId</small>
                                                                                        </div>
                                                                                    </div>
                                                                                </td>
                                                                                <td class="text-center fw-bold text-dark">x @detail.Quantity</td>
                                                                                <td class="text-end text-muted">@detail.Price.ToString("C2")</td>
                                                                                <td class="text-end pe-4 fw-bold text-primary">@((detail.Quantity * detail.Price).ToString("C2"))</td>
                                                                            </tr>
                                                                        }
                                                                    </tbody>
                                                                </table>
                                                            </div>

                                                            <div class="row g-3">
                                                                <div class="col-md-6">
                                                                    <div class="bg-white p-3 rounded-3 shadow-sm h-100 border-start border-4 border-primary">
                                                                        <h6 class="text-uppercase text-primary fw-bold small mb-3">
                                                                            <i class="fas fa-map-marker-alt me-2"></i>Teslimat Bilgileri
                                                                        </h6>
                                                                        <p class="mb-1 fw-bold text-dark">@order.FullName</p>
                                                                        <p class="mb-1 text-secondary small">@order.AddressLine</p>
                                                                        <p class="mb-0 text-secondary small fw-bold">@order.District / @order.City</p>
                                                                    </div>
                                                                </div>
                                                                <div class="col-md-6">
                                                                    <div class="bg-white p-3 rounded-3 shadow-sm h-100 border-start border-4 border-success">
                                                                        <h6 class="text-uppercase text-success fw-bold small mb-3">
                                                                            <i class="fas fa-receipt me-2"></i>Ödeme Özeti
                                                                        </h6>
                                                                        <div class="d-flex justify-content-between mb-1">
                                                                            <span class="text-muted small">Ara Toplam:</span>
                                                                            <span class="fw-bold small">@order.TotalPrice.ToString("C2")</span>
                                                                        </div>
                                                                        <div class="d-flex justify-content-between mb-1">
                                                                            <span class="text-muted small">Kargo:</span>
                                                                            <span class="fw-bold small text-success">Ücretsiz</span>
                                                                        </div>
                                                                        <hr class="my-2 opacity-25">
                                                                        <div class="d-flex justify-content-between align-items-center">
                                                                            <span class="fw-bold text-dark">Genel Toplam:</span>
                                                                            <span class="fw-bold text-primary fs-5">@order.TotalPrice.ToString("C2")</span>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        }
                                    </div>
                                }
                            </div>

                            <div class="tab-pane fade" id="settings" role="tabpanel">
                                <form asp-controller="Profile" asp-action="Update" method="post" enctype="multipart/form-data">
                                    <div class="row justify-content-center">
                                        <div class="col-lg-8">

                                            <div class="text-center mb-5">
                                                <div class="position-relative d-inline-block">
                                                    <img src="@(string.IsNullOrEmpty(Model.User.ImageUrl) ? "https://via.placeholder.com/150" : "/userimages/" + Model.User.ImageUrl)"
                                                         class="rounded-circle shadow border border-4 border-white"
                                                         width="140" height="140" style="object-fit: cover;">

                                                    <label for="UserImage" class="btn btn-primary btn-sm rounded-circle position-absolute bottom-0 end-0 shadow border border-2 border-white"
                                                           style="width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; cursor: pointer;">
                                                        <i class="fas fa-camera"></i>
                                                    </label>
                                                </div>
                                                <input type="file" name="UserImage" id="UserImage" class="d-none" accept="image/*">
                                                <p class="text-muted mt-2 small">Profil fotoğrafını güncellemek için ikona tıklayın</p>
                                            </div>

                                            <div class="row g-4">
                                                <div class="col-md-6">
                                                    <label class="form-label fw-bold text-dark">Adınız</label>
                                                    <div class="input-group">
                                                        <span class="input-group-text bg-light border-end-0"><i class="fas fa-user text-muted"></i></span>
                                                        <input type="text" name="Name" class="form-control bg-light border-start-0 ps-0" value="@Model.User.Name">
                                                    </div>
                                                </div>
                                                <div class="col-md-6">
                                                    <label class="form-label fw-bold text-dark">Soyadınız</label>
                                                    <div class="input-group">
                                                        <span class="input-group-text bg-light border-end-0"><i class="fas fa-user text-muted"></i></span>
                                                        <input type="text" name="Surname" class="form-control bg-light border-start-0 ps-0" value="@Model.User.Surname">
                                                    </div>
                                                </div>
                                                <div class="col-12">
                                                    <label class="form-label fw-bold text-dark">E-Posta Adresi</label>
                                                    <div class="input-group">
                                                        <span class="input-group-text bg-light border-end-0"><i class="fas fa-envelope text-muted"></i></span>
                                                        <input type="email" class="form-control bg-light border-start-0 ps-0 text-muted" value="@Model.User.Email" disabled>
                                                    </div>
                                                    <small class="text-muted ms-1"><i class="fas fa-lock me-1"></i>Bu alan güvenlik nedeniyle değiştirilemez.</small>
                                                </div>

                                                <div class="col-12 mt-4">
                                                    <button type="submit" class="btn btn-primary w-100 py-3 rounded-pill fw-bold shadow-sm transition-hover">
                                                        <i class="fas fa-save me-2"></i>Değişiklikleri Kaydet
                                                    </button>
                                                </div>
                                            </div>

                                        </div>
                                    </div>
                                </form>

                                <div class="row justify-content-center mt-5">
                                    <div class="col-lg-8">
                                        <div class="card border border-danger shadow-sm bg-danger bg-opacity-10">
                                            <div class="card-body p-4">
                                                <h5 class="fw-bold text-danger mb-2"><i class="fas fa-exclamation-triangle me-2"></i>Tehlikeli Bölge</h5>
                                                <p class="text-dark small mb-3">
                                                    Hesabınızı kapatırsanız, bu işlem geri alınamaz. Sipariş geçmişiniz anonim olarak sistemde kalacaktır ancak hesabınıza bir daha erişemezsiniz.
                                                </p>
                                                <button onclick="confirmDeleteAccount()" class="btn btn-outline-danger w-100 rounded-pill fw-bold">
                                                    <i class="fas fa-user-times me-2"></i>Hesabımı Kalıcı Olarak Sil
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                            </div>

                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script>
        function toggleOrder(orderId) {
            var collapseElement = document.getElementById('orderDetails-' + orderId);
            var bsCollapse = new bootstrap.Collapse(collapseElement, {
                toggle: false
            });

            if (collapseElement.classList.contains('show')) {
                bsCollapse.hide();
                document.getElementById('icon-' + orderId).classList.replace('fa-chevron-up', 'fa-chevron-down');
            }
            else {
                bsCollapse.show();
                document.getElementById('icon-' + orderId).classList.replace('fa-chevron-down', 'fa-chevron-up');
            }
        }

        // --- YENİ EKLENEN SWEETALERT FONKSİYONLARI ---

        // 1. SİPARİŞ İPTAL ONAYI
        function confirmCancelOrder(orderId) {
            Swal.fire({
                title: 'Siparişi İptal Et',
                text: "Bu siparişi iptal etmek istediğinize emin misiniz?",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'Evet, İptal Et!',
                cancelButtonText: 'Vazgeç',
                background: '#fff',
                focusCancel: true
            }).then((result) => {
                if (result.isConfirmed) {
                    // Formu programatik olarak gönder
                    document.getElementById('cancelForm-' + orderId).submit();
                }
            })
        }

        // 2. ÜRÜN İADE ONAYI
        function confirmReturnOrder(orderId) {
            Swal.fire({
                title: 'İade Talebi',
                text: "Bu siparişi iade etmek istediğinize emin misiniz? Süreç başlatılacaktır.",
                icon: 'info',
                showCancelButton: true,
                confirmButtonColor: '#6c757d',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'Evet, İade Et',
                cancelButtonText: 'Vazgeç',
                background: '#fff',
                focusCancel: true
            }).then((result) => {
                if (result.isConfirmed) {
                    document.getElementById('returnForm-' + orderId).submit();
                }
            })
        }

        // HESAP SİLME ONAYI (Zaten vardı)
        function confirmDeleteAccount() {
            Swal.fire({
                title: 'Çok Emin misiniz?',
                text: "Hesabınız kalıcı olarak silinecek! Bu işlem geri alınamaz.",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'Evet, Hesabımı Sil',
                cancelButtonText: 'Vazgeç',
                background: '#fff',
                focusCancel: true
            }).then((result) => {
                if (result.isConfirmed) {
                    window.location.href = "/Profile/DeleteAccount";
                }
            })
        }
    </script>
}